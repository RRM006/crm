// Prisma Schema for Multi-Tenant CRM

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== USER MANAGEMENT ====================

model User {
  id                String            @id @default(uuid())
  name              String
  email             String            @unique
  password          String
  avatar            String?
  phone             String?           @unique
  bio               String?
  isEmailVerified   Boolean           @default(false)
  isPhoneVerified   Boolean           @default(false)
  
  // Google OAuth Integration
  googleId          String?           @unique
  googleEmail       String?
  googleAvatar      String?
  googleLinkedAt    DateTime?
  
  // Telegram Integration
  telegramId        String?           @unique
  telegramChatId    String?
  telegramUsername  String?
  telegramLinkedAt  DateTime?
  
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  // Relations
  refreshTokens     RefreshToken[]
  userCompanyRoles  UserCompanyRole[]
  ownedCompanies    Company[]         @relation("CompanyOwner")
  notifications     Notification[]
  
  // CRM Relations (as creator/owner)
  createdCustomers  Customer[]        @relation("CustomerCreator")
  createdLeads      Lead[]            @relation("LeadCreator")
  assignedLeads     Lead[]            @relation("LeadAssignee")
  createdContacts   Contact[]         @relation("ContactCreator")
  createdTasks      Task[]            @relation("TaskCreator")
  assignedTasks     Task[]            @relation("TaskAssignee")
  createdNotes      Note[]            @relation("NoteCreator")
  createdActivities Activity[]        @relation("ActivityCreator")
  
  // Issue Relations
  createdIssues     Issue[]           @relation("IssueCustomer")
  resolvedIssues    Issue[]           @relation("IssueResolver")
  issueCalls        IssueCall[]

  @@map("users")
}

model RefreshToken {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@map("refresh_tokens")
}

// ==================== COMPANY / TENANT ====================

model Company {
  id          String   @id @default(uuid())
  name        String
  slug        String   @unique
  logo        String?
  website     String?
  industry    String?
  size        String?
  address     String?
  city        String?
  country     String?
  phone       String?
  email       String?
  description String?
  isActive    Boolean  @default(true)
  ownerId     String
  owner       User     @relation("CompanyOwner", fields: [ownerId], references: [id])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  userCompanyRoles UserCompanyRole[]
  customers        Customer[]
  leads            Lead[]
  contacts         Contact[]
  tasks            Task[]
  notes            Note[]
  activities       Activity[]
  products         Product[]
  services         Service[]
  issues           Issue[]

  @@map("companies")
}

// ==================== USER-COMPANY-ROLE MAPPING ====================

enum Role {
  ADMIN
  STAFF
  CUSTOMER
}

model UserCompanyRole {
  id        String   @id @default(uuid())
  userId    String
  companyId String
  role      Role
  isActive  Boolean  @default(true)
  joinedAt  DateTime @default(now())
  updatedAt DateTime @updatedAt

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([userId, companyId, role])
  @@map("user_company_roles")
}

// ==================== CRM ENTITIES ====================

enum CustomerStatus {
  ACTIVE
  INACTIVE
  PENDING
  CHURNED
}

model Customer {
  id          String         @id @default(uuid())
  name        String
  email       String
  phone       String?
  company     String?
  address     String?
  city        String?
  country     String?
  status      CustomerStatus @default(ACTIVE)
  notes       String?
  avatar      String?
  totalSpent  Float          @default(0)
  
  // Tenant isolation
  companyId   String
  tenantCompany Company      @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  // Creator
  createdById String
  createdBy   User           @relation("CustomerCreator", fields: [createdById], references: [id])
  
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  // Relations
  leads       Lead[]
  contacts    Contact[]
  tasks       Task[]
  customerNotes Note[]
  activities  Activity[]

  @@map("customers")
}

enum LeadStatus {
  NEW
  CONTACTED
  QUALIFIED
  PROPOSAL
  NEGOTIATION
  WON
  LOST
}

enum LeadSource {
  WEBSITE
  REFERRAL
  SOCIAL_MEDIA
  EMAIL_CAMPAIGN
  COLD_CALL
  TRADE_SHOW
  OTHER
}

model Lead {
  id          String     @id @default(uuid())
  title       String
  description String?
  value       Float      @default(0)
  status      LeadStatus @default(NEW)
  source      LeadSource @default(OTHER)
  priority    Int        @default(1) // 1-5
  
  // Customer link (optional)
  customerId  String?
  customer    Customer?  @relation(fields: [customerId], references: [id], onDelete: SetNull)
  
  // Tenant isolation
  companyId   String
  tenantCompany Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  // Creator & Assignee
  createdById String
  createdBy   User       @relation("LeadCreator", fields: [createdById], references: [id])
  assignedToId String?
  assignedTo  User?      @relation("LeadAssignee", fields: [assignedToId], references: [id])
  
  expectedCloseDate DateTime?
  closedAt    DateTime?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  // Relations
  tasks       Task[]
  notes       Note[]
  activities  Activity[]

  @@map("leads")
}

model Contact {
  id          String   @id @default(uuid())
  firstName   String
  lastName    String
  email       String
  phone       String?
  jobTitle    String?
  department  String?
  avatar      String?
  isPrimary   Boolean  @default(false)
  
  // Customer link (optional)
  customerId  String?
  customer    Customer? @relation(fields: [customerId], references: [id], onDelete: SetNull)
  
  // Tenant isolation
  companyId   String
  tenantCompany Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  // Creator
  createdById String
  createdBy   User     @relation("ContactCreator", fields: [createdById], references: [id])
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("contacts")
}

enum TaskStatus {
  TODO
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

model Task {
  id          String       @id @default(uuid())
  title       String
  description String?
  status      TaskStatus   @default(TODO)
  priority    TaskPriority @default(MEDIUM)
  dueDate     DateTime?
  completedAt DateTime?
  
  // Optional relations
  customerId  String?
  customer    Customer?    @relation(fields: [customerId], references: [id], onDelete: SetNull)
  leadId      String?
  lead        Lead?        @relation(fields: [leadId], references: [id], onDelete: SetNull)
  
  // Tenant isolation
  companyId   String
  tenantCompany Company    @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  // Creator & Assignee
  createdById String
  createdBy   User         @relation("TaskCreator", fields: [createdById], references: [id])
  assignedToId String?
  assignedTo  User?        @relation("TaskAssignee", fields: [assignedToId], references: [id])
  
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  @@map("tasks")
}

model Note {
  id          String   @id @default(uuid())
  content     String
  isPinned    Boolean  @default(false)
  
  // Optional relations
  customerId  String?
  customer    Customer? @relation(fields: [customerId], references: [id], onDelete: SetNull)
  leadId      String?
  lead        Lead?     @relation(fields: [leadId], references: [id], onDelete: SetNull)
  
  // Tenant isolation
  companyId   String
  tenantCompany Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  // Creator
  createdById String
  createdBy   User     @relation("NoteCreator", fields: [createdById], references: [id])
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("notes")
}

enum ActivityType {
  CALL
  EMAIL
  MEETING
  TASK_COMPLETED
  NOTE_ADDED
  LEAD_CREATED
  LEAD_STATUS_CHANGED
  CUSTOMER_CREATED
  DEAL_WON
  DEAL_LOST
  OTHER
}

model Activity {
  id          String       @id @default(uuid())
  type        ActivityType
  title       String
  description String?
  metadata    Json?
  
  // Optional relations
  customerId  String?
  customer    Customer?    @relation(fields: [customerId], references: [id], onDelete: SetNull)
  leadId      String?
  lead        Lead?        @relation(fields: [leadId], references: [id], onDelete: SetNull)
  
  // Tenant isolation
  companyId   String
  tenantCompany Company    @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  // Creator
  createdById String
  createdBy   User         @relation("ActivityCreator", fields: [createdById], references: [id])
  
  createdAt   DateTime     @default(now())

  @@map("activities")
}

// ==================== PRODUCTS & SERVICES ====================

model Product {
  id          String   @id @default(uuid())
  name        String
  description String?
  sku         String?
  price       Float    @default(0)
  currency    String   @default("USD")
  category    String?
  isActive    Boolean  @default(true)
  
  // Tenant isolation
  companyId   String
  tenantCompany Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("products")
}

model Service {
  id          String   @id @default(uuid())
  name        String
  description String?
  hourlyRate  Float?
  fixedPrice  Float?
  currency    String   @default("USD")
  category    String?
  isActive    Boolean  @default(true)
  
  // Tenant isolation
  companyId   String
  tenantCompany Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("services")
}

// ==================== ISSUES & SUPPORT ====================

enum IssueStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  CLOSED
}

enum IssuePriority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum IssueCategory {
  BILLING
  TECHNICAL
  GENERAL
  FEATURE_REQUEST
  BUG_REPORT
  OTHER
}

model Issue {
  id          String        @id @default(uuid())
  title       String
  description String
  status      IssueStatus   @default(OPEN)
  priority    IssuePriority @default(MEDIUM)
  category    IssueCategory @default(GENERAL)
  
  // Customer who created the issue
  customerId  String
  customer    User          @relation("IssueCustomer", fields: [customerId], references: [id])
  
  // Admin who resolved the issue (optional)
  resolvedById String?
  resolvedBy   User?        @relation("IssueResolver", fields: [resolvedById], references: [id])
  resolvedAt   DateTime?
  resolution   String?
  
  // Tenant isolation
  companyId   String
  tenantCompany Company     @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  // Relations
  calls       IssueCall[]

  @@map("issues")
}

model IssueCall {
  id          String   @id @default(uuid())
  issueId     String
  issue       Issue    @relation(fields: [issueId], references: [id], onDelete: Cascade)
  
  // Call details
  callType    String   @default("OUTBOUND") // INBOUND, OUTBOUND
  duration    Int      @default(0) // in seconds
  status      String   @default("COMPLETED") // COMPLETED, MISSED, NO_ANSWER, BUSY
  notes       String?
  recordingUrl String?
  
  // Who made the call
  callerId    String
  caller      User     @relation(fields: [callerId], references: [id])
  
  createdAt   DateTime @default(now())

  @@map("issue_calls")
}

// ==================== NOTIFICATIONS ====================

enum NotificationType {
  NEW_LEAD
  LEAD_ASSIGNED
  LEAD_STATUS_CHANGED
  NEW_TASK
  TASK_DUE_SOON
  TASK_OVERDUE
  TASK_COMPLETED
  NEW_ISSUE
  ISSUE_RESOLVED
  NEW_CUSTOMER
  CUSTOMER_JOINED
  GENERAL
}

model Notification {
  id          String           @id @default(uuid())
  type        NotificationType
  title       String
  message     String
  data        Json?            // Additional data (leadId, taskId, etc.)
  
  // Recipient
  userId      String
  user        User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Tenant isolation
  companyId   String?
  
  // Status
  isRead      Boolean          @default(false)
  readAt      DateTime?
  sentViaTelegram Boolean      @default(false)
  telegramMessageId String?
  
  createdAt   DateTime         @default(now())

  @@map("notifications")
}

